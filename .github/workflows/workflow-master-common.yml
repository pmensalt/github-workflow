name: Workflow Master Common

on:
  workflow_call:
    inputs:
      use-java:
        required: false
        type: boolean
        default: true
      java-version:
        required: false
        type: string
        default: '25'
      increment-version:
        required: false
        type: boolean
        default: true
      increment-version-property:
        required: false
        type: string
      debug-mode:
        required: false
        type: boolean
        default: true
      settings-file:
        required: true
        type: string
    secrets:
      TOKEN_READ_PACKAGE:
        required: true
      TOKEN_WRITE_PACKAGE:
        required: true

jobs:
  workflow-master-common:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    concurrency:
      group: master
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'graalvm'

      - name: Bump version and push tag
        if: ${{ inputs.increment-version }}
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.TOKEN_READ_PACKAGE }}
          
      - name: Display the tag
        if: ${{ inputs.debug-mode && inputs.increment-version }}
        run: |
          echo ${{ steps.tag_version.outputs.new_tag }}
          
      - name: Display the previous tag
        if: ${{ inputs.debug-mode && inputs.increment-version }}
        run: |
          echo ${{ steps.tag_version.outputs.previous_tag }}
          
      - name: Display the version
        if: ${{ inputs.debug-mode && inputs.increment-version }}
        run: |
          echo ${{ steps.tag_version.outputs.new_version }}
          
      - name: Display the previous version
        if: ${{ inputs.debug-mode && inputs.increment-version }}
        run: |
          echo ${{ steps.tag_version.outputs.previous_version }}
          
      - name: Display the release type
        if: ${{ inputs.debug-mode && inputs.increment-version }}
        run: |
          echo ${{ steps.tag_version.outputs.release_type }}     

      - name: Download Settings File
        run: |
          curl -o settings.xml -H "Authorization: token ${{ secrets.TOKEN_READ_PACKAGE }}" ${{ inputs.settings-file }}     

      - name: Set maven version
        if: ${{ inputs.increment-version && !inputs.increment-version-property }}
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_READ_PACKAGE }}
          TOKEN_READ_PACKAGE: ${{ secrets.TOKEN_READ_PACKAGE }}
        run: mvn versions:set -DnewVersion=${{ steps.tag_version.outputs.new_version }} --settings settings.xml
        
      - name: Set maven property version
        if: ${{ inputs.increment-version && inputs.increment-version-property}}
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_READ_PACKAGE }}
          TOKEN_READ_PACKAGE: ${{ secrets.TOKEN_READ_PACKAGE }}
        run: mvn versions:set-property -Dproperty=${{ inputs.increment-version-property }} -DnewVersion=${{ steps.tag_version.outputs.new_version }} --settings settings.xml
        
      - name: Build with Maven
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_READ_PACKAGE }}
          TOKEN_READ_PACKAGE: ${{ secrets.TOKEN_READ_PACKAGE }}
        run: mvn -B package --file pom.xml --settings settings.xml

      - name: Show effective POM
        run: mvn help:effective-pom --settings settings.xml

      - name: Publish to GitHub Packages Apache Maven
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_WRITE_PACKAGE }}
        run: mvn --batch-mode deploy --settings settings.xml

      - name: Commit new version
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v7
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_WRITE_PACKAGE }}
        with:
          commit_message: Automatic version bump
          file_pattern: 'pom.xml'